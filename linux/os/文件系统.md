## 文件系统

虽然Unix操作系统要比Windwos系统要稳定。但是Unix操作系统有时候也会有闹脾气罢工的时候。这主要是因为Unix操作系统中inode块与超级块在作怪。
那么这两个块在Unix操作系统中到底占据了什么位置呢?
###  inode块，Unix文件的核心。
首先需要明白的是，在Unix操作系统中的任何资源都被当作文件来管理。如目录、光驱、终端设备等等，都被当作是一种文件。从这方面来说，
Unix操作系统中的所有的目录、硬件设备跟普通文件一样，具有共同的属性。而这些属性的话，就是保存在inode块中。
Inode块中保存了一个文件系统中的全部Inode节点。也就是说，当系统创建了一个文件(或者添加了一个新设备)时，
系统就会从这个块中给这个文件分配一个Inode结点。在这个结点中存储了这个文件的大部分属性，如创建、修改时间等等。但是需要注意的是，
有两个属性不包含在这个inode结点中，分别为文件名与结点号。这主要是因为inode节点按顺序排列，所以系统内核就可以采用简单的算法，
就可以得出inode节点号。通过系统提供的ls命令显示文件或者目录信息的时候，就需要用到这个结点中的信息。
Ls命令为了确定一个文件的Inode节点需要查找它所在的目录，然后读取它的Inode 结点，并根据inode节点得到文件的属性。正常情况下，
这个节点号不会出现什么问题。但是如果由于意外断电或者其他原因的话，有可能会发生一些故障。如可能一个inode结点在系统中已经被创建，
但是其没有被正常使用，或者可能块号超出了范围。这些故障会给操作系统留下安全隐患。为此当出现意外关机或者其他意外事件时，
最好系统工程师能够利用fsck系统命令来修复inode结点中的错误。
另外需要注意的是，在inode结点中还存储着一个重要的信息，就是保存了一个包含13-15位指针元素的数组，这些指针是磁盘块区的地址。
这些指针非常的重要。操作系统就是依靠这些指针在硬盘上定位相关的文件，并读取它。如上所述，因为一些意外的操作也会使得这个指针地址出现错误。
有时候这会非常的严重。如一些文件无法读取等等。如果这些文件不幸的是系统的一些配置文件，那么就会导致系统的崩溃。如果这些指针地址出现错误，
则文件名仍然会显示在操作系统中。但是如果用户试着去打开这些文件时，系统却会告知无法打开这些文件。如果遇到这种情况该这么办呢?
此时系统工程师就需要手工运行fsck命令。如果这个文件损坏的不是很严重，那么操作系统内内核会为其再建立一个链接。但是如果原文件损坏的比较厉害了，
无法再重新读取。则系统会建立用户删除这个文件(从硬盘中删除)。
由于一些文件的属性(如建立修改时间等等)都保存在Inode结点中，为此一些命令在获取这些属性的时候，是不需要打开文件的。
如现在系统工程师在编写一个文件备份程序，就需要用到inode节点中的修改时间截这个属性。此时可以利用相关的命令直接从inode结点中去获取，
而不需要打开对应的文件去得知这个信息。为此在Unix操作系统中文件备份程序的执行效率会比较高，实现起来也相对简单一点。
从上面的这些分析中可以看到，inode结点是Unix操作系统中文件的核心，也是操作系统与硬盘中存储的数据打交道的一个中介者。
如果这个结点信息出现错误的话，那么硬盘中存储的数据块就好像是无主的流浪者，无法被用户所采用。另外我们平时删除文件，其实只是删除了这个联系。
所以通过一线恢复工具仍然可以恢复被删除了的文件。如果需要真正删除文件的话，就需要格式化硬盘(低格)或者复制大文件把其覆盖掉。
只有如此硬盘中存储的数据块才会被真正的删除掉。最后需要说明的是，按照正常的关机程序来关闭Unix操作系统，是保护inode结点信息的最好措施。突然断电或者其他意外事故，是inode结点的最大杀手。

###　　二、超级块，文件系统的心脏。
如果说inode块是Unix操作系统中文件的核心，那么超级块就是文件系统的心脏。启动Unix操作系统后，发现某个文件系统无法使用，
很有可能就是超级块出现了问题。为什么这个超级块有这么大的作用呢?主要是因为在超级块中保存了全局文件信息，
如硬盘已用空间、数据块可用空间、inode结点信息等等。做一个形象的比喻，这个超级块就好像是企业的资产负债表，
一个文件系统中有哪些资源都记录在这个表中。
当操作系统启动后，系统内核会把超级块中的内容复制到内存中，并周期性的利用内存里的最新内容去更新硬盘上的超级块中的内容。
由于这个更新存在一个时间差，为此内存中的超级块信息与硬盘中的超级块信息往往只有在开机与关机的某个特定时刻是同步的;而在其他时间都是不同步的。
假设当操作系统意外当机或者因为断电而造成的意外事故时，内存中的超级块信息没有及时保存到硬盘中，此时文件系统的完整性就会受到破坏。
轻者导致刚建立的丢失，重则的话会导致文件系统瘫痪。遇到这种情况时，系统工程师往往需要利用系统提供的sync命令在系统出现故障的那一刻把内存里的
内容复制到磁盘上。这个过程往往操作系统会自动完成，这也正是因为为什么Unix操作系统要比Windows操作系统稳定的一个重要原因。当操作系统重新启动
的过程中，系统内核会对两者进行比较，根据他们之间的差异，给文件系统打上干净或者脏的标签。这个信息也是存储在文件系统的超级块中。
　　可见超级块如果发生损坏的话，对于文件系统的破坏性非常的大。轻者的话导致某个文件系统无法挂载，重则的话导致整个操作系统崩溃。
在Unix操作系统中，除了可以利用sync命令来保证硬盘上的内容决不会比内存里的内容更新之外，还提供了一个很有利的措施来保证其的安全性。其实，
这个技术很早就有，只是一开始并没有用在超级块的管理中。这个技术就是跟磁盘阵列类似。操作系统会将多个超级块内容保存到硬盘中的不同区域。
当其中一个超级块出现问题时，操作系统会自动采用另外一个超级块。等到系统运行正常后，系统内容就会把可用的超级块去替换那个故障的超级块。
为此除非所有的超级块都损坏了，否则的话，只要有一个超级块是可用的，那么文件系统与操作系统就可以正常挂载与启动。这种安全机制在很大程度上提高了
超级块的安全性，系统了Unix操作系统的稳定性。现在大部分的Unix操作系统(包括Linux操作系统)已经实现了类似的安全机制。

在超级块中保存了如下有用的信息。一是保存了文件系统的大小以及所用的块的大小;
二是保存了可用数据库的数量和部分可以及时分配的空闲数据块列表;三是最近一次的更新时间与文件系统的状态;
四是空闲Inode结点的个数和部分可以及时使用的inode结点列表。有时候在Unix操作系统上进行应用程序开发也需要用到这些信息。
超级块损坏的最大杀手仍然是意外断电或者其他原因的意外当机。因为此时内存中的超级块信息无法及时更新到硬盘中。为此就出现了内存与超级块中内容不一
致的地方，从而会导致系统启动时的一系列故障。为此在Unix服务器上部署一个UPS是非常重要的。这虽然是一个老生常谈的方法，但是却非常有效。
